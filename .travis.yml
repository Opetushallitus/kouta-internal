sudo: required
dist: xenial
language: scala
scala:
  - 2.12.2
jdk:
  - openjdk8
services:
  - docker
  - postgresql

addons:
  postgresql: "11"
  apt:
    packages:
      - postgresql-11
      - postgresql-client-11

cache:
  directories:
  - $HOME/.m2

env:
  global:
    - PGPORT=5433
    # AWS_ACCESS_KEY_ID
    - secure: "Q+5HBRLdLXNz2/gcAQSS6xCJdNAQtOaoaJ31IdfxXSDRI4LPr63xXFHD3MleFSzRb6+JYVJ1Gnwfoci5mqDKhDZK8V8m0ufG66Ic8YeFGMMyqSjXEBw9E1te1EAC91H/UEJfTEWLW9tYY7PYCaBF0/I/f3qfrOrczoe42DjmhBmohcd0Dyxerjp5Iv6p1ksEdtlnjcVdbt9Qf4hBulbz3i46L+b8BSphlOEeaY2fYu6KbqGJlKvy77sWXPDiCzqGcv7bXJj3G71I1YQQfHrw79Wc2uQrbFauVXiTTLmwXPKqqlmlkFW2roVxTeML9gbIvc21y+PskvHpBUrkIwjL+CpaoTTj8pSOfSS/vB/tSWtjC1+UsWRb0qWGg3aYbTQa37Lfmfm0K21Xcjg9GOPJ0sJEVeTlB8N5ShiCMmv9ASozA1LooQ9TkXmSc/ttdWFHQbjqKU1cecHU+fWjoDXN6B3nFnn59NxHFUNeyAiiFhLJncaMk8uF4dz0v4nh9VZEZEZSjEkKXQkabHNOe7FmfFJNRXqQ2xDrc9gat8ORKI4FpgnY8gid7QaaF5f5ALgBEuH1//WFtv5XzXUyCEP7MhgMPFgzgSqp0JiEgh3ksqgS+y25DXYhtGWfvUlJFcZpwNQfxhE9TS6ew1e/O1iQ+dP95CK7DncqXRy3G225WDQ="
    # AWS_SECRET_ACCESS_KEY
    - secure: "X9pFc2lKTJVD2+S4eh0jrYYjShGXHwSpRRiCZVqELgiHyGsNtxcCDANB6J/xGdMdDbBWri/mzLy1BinEZfxyk9Q+V/MsdoQ1inQVTqvDxWC7qn4PgiLfMO4/qRTJWipl2YZTE7Ve85PJg2yiH40PIiiZeymkVJL4BwS74hFbgIj70uYi22K6WwmEstdqXFv8dCQzGg+buKMFOzE7SYN247L5RH5BRk/ngQnVff2tBJulNehK8B3rs2GgqZFhxEvz4eDOlpfgkOO0hVxr1ftqmg/98Kcym81iyKOE6Mia+hfrjFIUHGSOp3FbIqYaVe3Iz+I+h0AxDKzXEQQRoCUT8uEiF39JYBPEqqrwn/AudrZB0pOzByroVpUAAEjBb9N76bjlNg3dWU904DF5m7gQdeTiTWIXmCBo4FC+FNzlzUBhxONbRRh20VplaHFN+k3GdbYaNvdv+AGM5+bJFrHBiq2iSejFcCLnVXJdb1NBaX7/GwS1MC0RNy22PQUfBtYy1Ga1RY/+K+0MOM89dEsJGLkI+/4Q9Cy3BH0ow9sb3du+C7Q8tuwFWGJVgdnICgnrgxtjm8xscIsM8hyqvEE4RcU1v7H8aj+jQaTLHiNRodBAtsbS8ydwzP9qmrBTAyeBGsouEo6BAj46m/KuzWW6nzQiQZMMMu+1ksA+Higb2Ss="    # ARTIFACTORY_USERNAME

before_install:
  # https://github.com/travis-ci/travis-ci/issues/9624
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo systemctl restart postgresql@11-main
  - sleep 1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="kouta-internal"

before_script:
  - DB_NAME=koutainternal
  - psql -c "create database $DB_NAME WITH ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' TEMPLATE template0;" -U postgres
  - psql -d $DB_NAME -f postgresql/init_it_postgresql.sql

script:
  - mvn install --batch-mode -DargLine="-Dkouta-internal.test-postgres-port=${PGPORT}"

  - mv target/kouta-internal-*-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
  - cp -vr src/main/resources/* $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
