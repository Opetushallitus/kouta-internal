sudo: required
dist: xenial
language: scala
scala:
  - 2.12.13
jdk:
  - openjdk11
services:
  - docker
  - postgresql

addons:
  postgresql: "11"
  apt:
    packages:
      - postgresql-11
      - postgresql-client-11

cache:
  directories:
  - $HOME/.m2

env:
  global:
    - PGPORT=5433
    # AWS_ACCESS_KEY_ID
    - secure: "FqUiHoACWgudBvIWpaeU5LbJnTLE+ccGNU2hjdtcJbfv2RGg3oYhBEKuEQnfMXUYtzlOyTXa/tlto2W/8G9DlSLF+W2jP9LBU01VftWKC09SZ40UCIp/Us2o1+9O9mRJLE+0D0HhRFk7X1WWEANLRiO6bZ78pzrBQWV7b5bk2hwuHhN+QkCi68xjajYCnxDOQeScpog6fFCeLsoifBEO5efw6lxeH0ZpH9holE5kQ4SAGSsyWvFYZfrCqIMfF46Bi5l+IQd0ShsRjFMZd4FRFgV8mq7ikABDHl9aRhispXmqokf8QIhUT7XMSi/8QpvOzmI5tuyQL+gaBYPTHy3kfLfB5l4shv98RTgHq5nieo8xdV40s6X1V8bx6WZ8GQYdmHC/ay39Uwtq+D20rqwHuybxbc4kLzL/Yb8h0StsnsYM4nBF6lq85V3ZPpVaJJzwVgwILWFPe6v4zsJ+u2ZTuxnn05ujnpMeXTTbGQQUxNOF55wg6wYGHnrI4EoIH4n29GbH5S5Y5u5KrSmeqwmuuBPEd1Nt8h1z/od0Tb9JqXjuYDatLkaZerjWDelzGv+Fg08G/UlQhcm4+huUbDeCtDHMwBkEWfPQM4zw5Eiu6ghjW4TSqJXBhmOFGB7PPf1ikx6umIT8S5JZ443GofQJY2iu4ZDDNjEx8z7518hRdUY="
    # AWS_SECRET_ACCESS_KEY
    - secure: "Tmq61sKb4ZN2jqZXudh8iB1gJO7uGjmiYFQMcv+4FdrKa6Wts7wl44mpZCCeWrrMyIZHH5SwUzLLxnIwldOfi8HSnFPXG1i2NJgghGyqwW6WP4rubLblXzOeUfimtiURjFLuNJOyGtwcXcFz1k6B0tIKlzOjUJE23+JoI4gbdUKHnypS5ukQVlGFgckJfPio8Qo0Xp2MRQ+IynTugO2Lln3IYH2s47JDhNcN2yTPtNF5H+9NEPj1GHKUhVkcywi6b7L0Z8iXIebiP8SUcaxHcHq35n0wKkE6P8ed0Mo4mfwZeg7fKmK7GKasHj69LXqZHR4DyhOtobj5rUo63w1XWlSiN8rZuvPQljdUmYQzo1UPUmP43V97nWkck0pP0/J3UzpC4GiuxCsrqq/fNTcNvnUUUhVLOWOAbUbjGLk1xP4h+GmKM+zuLmzBlHuhgc5bUivUl+V3dUtz+LgH0NHT3lsifZ4BHt1XJHMCObqC16s5M0Iaby7FjXOaTDXE9UqdWecSt7auzVgMQ53M2XzR8WITdNJRR8zPw9wiIoZJpQlrz5Ttz0+fYoTTFhT0IYZJ+hFemncEJL0mfQ5tP9I/0C1aFWKLVhXC7vp9b4koTyf/QFdaQKnEZeAddhuCMv8OscEkmf/oht8Io17cYghCHcSNjyQNsr3XNLobYTqafhI="

before_install:
  # https://github.com/travis-ci/travis-ci/issues/9624
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo systemctl restart postgresql@11-main
  - sleep 1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="kouta-internal"

before_script:
  - DB_NAME=koutainternal
  - psql -c "create database $DB_NAME WITH ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' TEMPLATE template0;" -U postgres
  - psql -d $DB_NAME -f postgresql/init_it_postgresql.sql

script: >-
  mvn spotless:check install --batch-mode -DargLine="-Dkouta-internal.test-postgres-port=${PGPORT}" &&
  mv target/kouta-internal-*-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar &&
  cp -vr src/main/resources/* $DOCKER_BUILD_DIR/config/ &&
  export BASE_IMAGE="baseimage-fatjar-openjdk11:master" &&
  ./ci-tools/common/pull-image.sh &&
  ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
