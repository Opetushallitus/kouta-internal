sudo: required
dist: xenial
language: scala
scala:
  - 2.12.2
jdk:
  - openjdk8
services:
  - docker
  - postgresql

addons:
  postgresql: "11"
  apt:
    packages:
      - postgresql-11
      - postgresql-client-11

cache:
  directories:
  - $HOME/.m2

env:
  global:
    - PGPORT=5433
    # AWS_ACCESS_KEY_ID
    - secure: "kB2uXQDlz9hG++dz1pbAHeZS8zB06QU9akjgtgSShBUuG6mVtg55G349uxZPuF/xDUBpLVQEt63o6R2wH/y7/M+PoKQcc9YpPAggMz4dnGfIT2JasZsYfkqndv94XZYTrIaC+RM/ylCfNPGsIcv+H/dHpbGH2d42YonHMSIexoBGP88ri6u3+BzcUvkinroGMZZ//vDhnETcFq2mTWetggwOKjFg6vGwSStHEGiAo5+8mSmQLbfQ7mRhKUVp9wgXzvDZEjXODvUAQfVucmSaBHpfa7IynVCg/T1zLp9W6NVVzhe21dnIb2PHua1qNinrY7zjfIs1F9CZh7qRwhrlE6Ml8gyYmQApL4/2mvCBayFNmXyQlC26bAGkc/g98qR4rI/ALyfBBk8UDirs5gcJ5nqLuDDMK7+AzrHCdSc3x53lQ9InKUGJ2osVy41OzcVSpjfYX25HdpNG9x6e0u9O44s6QJ6WWex3Yal5lvDjTrPuQyHszyMH7hs+DXcJXMkX9Ou2nvISOtmvyPAYTYYsOUOW0Xg7HNVumrOBc7GSGBNEZ80/siRT5GN0eMpFc5WO88KnEiwZ7g//o4gJ/mX6slwEZwyeTn87yX6ukgkZkM9A6VZqa7/CxmBEeXTAypzFT/R/Vn4Lh/D0Yct2K6jZq5aPQytJQllAe+Nca9BxL4k="
    # AWS_SECRET_ACCESS_KEY
    - secure: "V7MBLWJdcIyjqNCHU/tM1cN0Svw4kbwM2YjOzAltLQeFPQgxUaQTj3kqnVJaV7pf9AWSs1+x7SKsz/szN5cb+Augz8R3T820zMhlsARFVsq4O9/1TY/yCRYDzdjWoSwIL7Fa5XsPtAXXY1RPLd5OPSRseG91s8V5F4G0SL4OWCHZ1WJ14ygnwBPmYq4EShpXJgWq5T/X2fVPecwLrMWmit1LYROOFl6tv6vUOTxOT6KG3TU9diOX2mEy54jJOFf4PEB360XwvdITX3SjAN88LKfstTuxtiSoKpbwnQl2IdvaaldwsyWAVcdnexY6uQc8G4Kp33ruYA+JV1LiC6Hafo/Qbe8f8mj7oYpRxWipa3sAjZruhY6CdFK3H7UGLL8PueHPJpg9/de6hZIqyj2mqcwvBgeFMPbc0IWc4xMVG6P7vO0zoO7rPRZPWUaEXmN2+QlYEI7aPEEsvOYXEdONVCp/Izw0mhWq2/t0qzGPw9sfRjPCbkxeM2uJTDqvQuLbc3ZisxpubOg/7t5+qKlAD0tLvdITQfM1EqoEueSVCVYIPNI6uE8kdWuMBzFApbXFsbxxEnfD88BtWSUbFSp03bHg+2uGhwETClgHXn2T6PH22Eol16dGz13sPljjeAlxTUCX5bUyN2IW2s2c5D8ZPGUZsrPT3C+bl5hdTk1dZCg="

before_install:
  # https://github.com/travis-ci/travis-ci/issues/9624
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo systemctl restart postgresql@11-main
  - sleep 1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="kouta-internal"

before_script:
  - DB_NAME=koutainternal
  - psql -c "create database $DB_NAME WITH ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' TEMPLATE template0;" -U postgres
  - psql -d $DB_NAME -f postgresql/init_it_postgresql.sql

script:
  - mvn install --batch-mode -DargLine="-Dkouta-internal.test-postgres-port=${PGPORT}"

  - mv target/kouta-internal-*-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
  - cp -vr src/main/resources/* $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
